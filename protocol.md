# 串口通信数据协议
本项目中所有数据通信通过单片机上的 RS485 通信模块完成。上位机与下位机之间需要通过 RS485 总线连接，上位机作为汇聚节点工作。所有数据传输均以数据头开始标识数据传输类型，部分类型在数据头之后还有相对应大小的数据。

一般情况下，不允许下位机主动向 RS485 总线上发送数据，下位机仅在必要时发送对上位机操作的回应数据。

## 数据头
数据头共 1 字节，其中高 4 位代表事件编号，低 4 位代表事件参数。

| 高四位 | 事件 | 低四位（参数/地址） |
| :---: | :---: | :---: |
| 0 | 终止记号 | 必须为 `f` |
| 1 | 上位机向下位机传输乐谱 | 目标下位机编号 |
| 2 | 下位机报告音乐结束 | 置零 |
| 3 | 开始播放音乐 | 置零 |
| 4 | 终止播放音乐 | 置零 |
| 5 | 预览指定机下位机音乐 | 目标下位机编号 |
| 6 | 停止指定下位机播放 | 目标下位机编号 |
| 7 | 发起同步请求 | 置零 |
| 8 | 同步继续播放 | 置零 |
| 9 | 加载内置音乐 | 内置音乐编号 |
| a |  |  |
| b |  |  |
| c |  |  |
| d |  |  |
| e | 操作成功 | 成功类型 |
| f | 产生错误 | 错误码 |

## 事件`0f`——终止记号
用于标记之前事件的终止，接收到的下位机会清除先前的事件信息。在项目实现中该事件未被使用。

## 事件 `1_`——传输乐谱到指定下位机
数据头 `0x1_`，其中 `_` 表示乐谱需要传输到的下位机编号。数据头之后 2 字节代表后面需要传输数据的大小（单位：字节；不包含数据头、校验位；高位在前）。其后为数据段，即乐谱的实际数据，每个音符占三字节，格式为“MIDI 音符编号，时值高 8 位，时值低 8 位”。数据段之后还有一个校验字节，其值等于数据段的每个字节的异或和。

## 事件 `20`——下位机报告音乐结束
仅可由 0 号节点下位机发送给上位机，指示音乐播放结束。

## 事件 `70`——发起同步请求
由 0 号节点下位机发送给上位机。上位机在收到该请求后，应当延时一段时间后回应 `0x80`。

## 事件 `80`——同步继续播放
由上位机发送给下位机。下位机在同步标记处暂停音乐播放时，如果收到 `0x80`，则会恢复播放。

## 事件 `e_`——操作成功
### 参数 `_`
- 0：由下位机发送给上位机。成功将数据传输到指定机器，通过异或和验证。

## 事件 `f_`——产生错误
### 参数 `_`
- 0：由下位机发送给上位机。将数据传输到下位机，未通过异或和验证。
- 1：由下位机发送给上位机。传输音乐数据时，数据大小超过下位机设定的限制，发送的数据均会被下位机舍弃。
